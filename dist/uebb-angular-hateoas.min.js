angular.module("uebb.hateoas",["pascalprecht.translate"]),angular.module("uebb.hateoas").directive("deleteResource",function(){"use strict";return{scope:{deleteResource:"=",onDelete:"&",onCancel:"&",label:"@",labelPrefix:"@"},restrict:"A",transclude:!0,template:"<span ng-transclude />",link:function(e,t){t.on("click",function(){e.openPopup()})},controller:["$scope","deletePopup",function(e,t){e.openPopup=function(){t({resource:e.deleteResource,onDelete:e.onDelete,onCancel:e.onCancel,label:e.label,labelPrefix:e.labelPrefix})}}]}}).factory("deletePopup",["$modal","$rootScope",function(e,t){"use strict";return function(r){var n=t.$new();n.resource=r.resource,n.label=r.label||"resource",n.labelPrefix=r.labelPrefix||"general",n.onDelete=r.onDelete,n.onCancel=r.onDeleted;var a=e.open({templateUrl:"uebb_hateoas_templates/delete-resource.html",keyboard:!1,scope:n,backdrop:"static"});return n["delete"]=function(){n.resource["delete"]().then(function(){a.close(),n.onDelete&&n.onDelete()},function(e){n.error=e.data})},{close:function(){a.close()}}}}]),angular.module("uebb.hateoas").filter("filesize",function(){var e=["bytes","KB","MB","GB","TB","PB"];return function(t,r){if(isNaN(parseFloat(t))||!isFinite(t))return"?";for(var n=0;t>=1024;)t/=1024,n++;return t.toFixed(+r)+" "+e[n]}}),angular.module("uebb.hateoas").factory("HateoasResource",["$http","Promise","hateoasUtil","hateoasCache","HateoasRequestError",function(e,t,r,n,a){"use strict";function i(){this.$originalData={},this.$links={}}i.prototype.setData=function(e){return angular.copy(r.getProperties(e),this),this.$originalData=e,this.$links=r.getLinks(e),t.resolve(this)},i.prototype.getData=function(){var e=r.copy(this);return delete e.$links,delete e.$originalData,e[r.linksProperty]=r.copy(this.$links),e},i.prototype.getLinks=function(e,r,n){var a=this.getHrefs(e);return a.length?t.all(a.map(function(e){return i.get(e,r,n)})):t.reject("Link not found "+e)},i.prototype.getLink=function(e,r,n){var a=this.getHref(e,r);return a?i.get(a,r,n):t.reject("Link not found "+e)},i.prototype.setLink=function(e,t){this.setHref(e,t.getHref("self"))},i.prototype.addLink=function(e,t){this.addHref(e,t.getHref("self"))},i.prototype.getHrefs=function(e,t){t&&(t=r.flatten(t));var n=[];return angular.isArray(this.$links[e])?n.push.apply(n,this.$links[e]):this.$links[e]&&n.push(this.$links[e]),n.map(function(e){return r.expandUriTemplate(decodeURI(e.href),t)})},i.prototype.getHref=function(e,t){var n=null;return angular.isArray(this.$links[e])&&this.$links[e].length?n=this.$links[e][0]:this.$links[e]&&(n=this.$links[e]),n?r.expandUriTemplate(decodeURI(n.href),t):void 0},i.prototype["delete"]=function(){var r=this.getHref("self");return t.resolve(e({method:"DELETE",url:r,headers:o,withCredentials:!0})).then(function(){n.invalidateRelated(this),n.remove(r)}.bind(this),l)},i.prototype.hasLink=function(e,t){return this.hasHref(e,t.getHref("self"))},i.prototype.hasHref=function(e,t){var n=this.getHref(e);if(void 0===t)return angular.isArray(n)?n.length>0:!!n;if(!angular.isArray(n)){var a=n;n=[],a&&n.push(a)}if(0===n.length)return!1;t=r.normalizeUrl(t);for(var i=0;i<n.length;i++)if(t===r.normalizeUrl(n[i]))return!0;return!1},i.prototype.isLinkedWith=function(e){for(var t in this.$links)if(this.$links.hasOwnProperty(t)&&this.hasLink(t,e))return!0;return!1},i.prototype.removeLink=function(e,t,r){return this.removeHref(e,t.getHref("self"),r)},i.prototype.removeHref=function(e,t,n){n&&(angular.isArray(this.$originalData[r.linksProperty][e])?0===this.$originalData[r.linksProperty][e].filter(function(e){return e.href===t}).length&&this.$originalData[r.linksProperty][e].push({href:t}):this.$originalData[r.linksProperty][e]?this.$originalData[r.linksProperty][e].href!==t&&(this.$originalData[r.linksProperty][e]=[this.$originalData[r.linksProperty][e],{href:t}]):this.$originalData[r.linksProperty][e]=[{href:t}]),t===!0&&delete this.$links[e],angular.isArray(this.$links[e])?angular.forEach(this.$links[e],function(r){r.href===t&&this.$links[e].splice(this.$links[e].indexOf(r),1)}.bind(this)):this.$links[e]&&this.$links[e].href===t&&delete this.$links[e]},i.prototype.setHref=function(e,t){this.$links[e]={href:t}},i.prototype.addHref=function(e,t){if(!angular.isArray(this.$links[e])){var r=[];this.$links[e]&&r.push(this.$links[e]),this.$links[e]=r}this.$links[e].push({href:t})},i.prototype.post=function(n){var a=this.getData(),i=!1,s={method:"POST",url:n,headers:angular.copy(o),data:a,withCredentials:!0};return Object.keys(a).forEach(function(e){a[e]instanceof File&&(i=!0)}),i&&(s.data=r.convertJsonToFormData(a),s.headers["Content-Type"]=void 0,s.transformRequest=function(e){return e}),t.resolve(e(s)).then(function(e){return 201===e.status&&("application/json-patch+json"===e.headers("Content-Type")&&angular.isArray(e.data)?this.applyPatch(e.data):(this.setHref("self",e.headers("Location"),!0),this.id=this.getHref("self").split("/").pop()),this.$originalData=this.getData()),this}.bind(this),l)},i.prototype.getPatch=function(){var e=r.getNormalizedData(this.$originalData),t=this.getData();return r.getPatch(e,t)},i.prototype.reset=function(){var e=this.$originalData;for(var t in this)this.hasOwnProperty(t)&&delete this[t];this.setData(e)},i.prototype.applyPatch=function(e){angular.forEach(e,function(e){var t=e.path.split("/");if(t.shift(),t[0]===r.linksProperty)switch(e.op){case"add":Array.isArray(e.value)?angular.forEach(e.value,function(e){this.setHref(t[1],e.href)}.bind(this)):this.setHref(t[1],e.value.href,!0);break;case"remove":Array.isArray(e.value)?angular.forEach(e.value,function(e){this.removeHref(t[1],e.href)}.bind(this)):this.removeHref(t[1],e.value.href)}else switch(e.op){case"replace":this[t[0]]=e.value;break;case"remove":delete this[t[0]]}}.bind(this))},i.prototype.reload=function(){return i.get(this.getHref("self"),null,!0)},i.prototype.save=function(e,t){var r;return r=this.getHref("self")?this.patch(t):this.post(e),r.then(function(){n.invalidateMatching(e),n.invalidateMatching(this.getHref("self")),angular.forEach(Object.keys(this.$links),function(e){angular.forEach(angular.isArray(this.$links[e])?this.$links[e]:[this.$links[e]],function(e){n.invalidateMatching(e.href)}.bind(this))}.bind(this))}.bind(this))},i.prototype.patch=function(r){var n=this.getHref("self"),a=this.getPatch();return 0!==a.length||r?t.resolve(e({method:"PATCH",url:n,headers:o,data:a,withCredentials:!0})).then(function(e){return"application/json-patch+json"===e.headers("Content-Type")&&this.applyPatch(e.data),this.$originalData=this.getData(),this}.bind(this),l):t.resolve(this)},i.setContentType=function(e,t){n.setContentType(e,t)},n.setDefaultCtor(i),i.get=function(a,i,s){a=r.addParamsToUrl(a,i);var u=n.getCachedPromise(a);if(!(!u||u.isRejected()||s&&u.isResolved()))return u;if(!s&&n.hasValidCache(a))return t.resolve(n.getCached(a));var c=t.defer(),d=e({method:"GET",url:a,headers:o,timeout:c.promise,withCredentials:!0}),f=t.resolve(d).cancellable()["catch"](t.CancellationError,function(e){return c.resolve(),t.reject(e)}).then(function(e){return n.addToCache(e.data,e.headers)}).then(function(e){return n.setCachedRedirect(a,e.getHref("self")),e},l);return n.setCached(a,null,null,f),f},i.clearCache=function(){n.clear()};var o={"Cache-Control":"no-cache",Pragma:"no-cache"};i.setDefaultHeader=function(e,t){null===t?delete o[e]:o[e]=t},i.setlinksProperty=function(e){r.linksProperty=e},i.setembeddedProperty=function(e){r.embeddedProperty=e};var l=function(e){throw new a(e)};return i.setDefaultErrorCallback=function(e){l=e},i.invalidateMatching=function(e){n.invalidateMatching(e)},i}]),angular.module("uebb.hateoas").factory("hateoasCache",["hateoasUtil","$q",function(e,t){function r(t){return t=e.normalizeUrl(t),w.hasOwnProperty(t)?w[t].resource:null}function n(t,r){return t=e.normalizeUrl(t),w.hasOwnProperty(t)?w[t].headers(r):null}function a(r){return r=e.normalizeUrl(r),w.hasOwnProperty(r)&&w[r].promise instanceof t&&!w[r].promise.isRejected()&&!w[r].invalid?w[r].promise:null}function i(t){t=e.normalizeUrl(t);var r=n(t,"Cache-Control"),a={};return angular.isString(r)&&angular.forEach(r.split(";"),function(e){var t=e.split("=");a[t[0]]=t[1]}),a}function o(t){t=e.normalizeUrl(t);var r=w[t];r&&(r.invalid=!0)}function l(e){try{return new URI(e).search("").hash("").toString()}catch(t){return e}}function s(e){e=l(e),Object.keys(w).forEach(function(t){l(t)===e&&o(t)})}function u(t){if(t=e.normalizeUrl(t),r(t)&&!w[t].invalid){var a=new Date(n("Date")).getTime(),o=i(t),l=parseInt(o["max-age"],10);if(!l||Date.now()-a>l)return!0}return!1}function c(t,r,n,a){t=e.normalizeUrl(t),w[t]=w[t]||{},r&&(w[t].resource=r),n&&(w[t].headers=n),w[t].promise=a,(a||r)&&(w[t].invalid=!1)}function d(t,r){t&&r&&(t=e.normalizeUrl(t),r=e.normalizeUrl(r),t!==r&&(w[t]=w[r]))}function f(e){return function(t){return"content-type"===t.toLowerCase()?"":e(t)}}function h(e){if(!x[e])for(var t in x)x.hasOwnProperty(t)&&e.match(t)&&(x[e]=x[t]);return x[e]||$}function p(e,t){var n=h(t("Content-Type"));return g(e,f(t)).then(function(){return(new n).setData(e)}).then(function(e){var n=e.getHref("self");if(n){var a=r(n);if(a){c(n,a,t,null);var i=a.getPatch();return a.setData(e.getData()).then(function(){return a.applyPatch(i),a})}c(n,e,t,null)}return e})}function g(r,n){var a=[];return angular.forEach(Object.keys(r[e.embeddedProperty]||{}),function(t){var i=r[e.embeddedProperty][t];Array.isArray(i)?angular.forEach(i,function(e){a.push(p(e,n))}):a.push(p(i,n))}),t.all(a)}function m(){for(var e in w)w.hasOwnProperty(e)&&delete w[e]}function v(e){delete w[e]}function y(e,t){x[e]=t}function b(e,t){Object.keys(w).forEach(function(r){w[r].resource&&(t?e.isLinkedWith(w[r].resource):w[r].resource.isLinkedWith(e))&&(w[r].invalid=!0)})}function k(e){e=l(e),Object.keys(w).forEach(function(t){if(l(t)===e){var n=r(t);n&&b(n,!0)}})}function P(e){$=e}var $,w={},x={};return{addToCache:p,getCached:r,getCachedHeader:n,getCachedPromise:a,invalidateCache:o,invalidateMatching:s,invalidateRelated:b,invalidateRelatedMatching:k,hasValidCache:u,setCachedRedirect:d,setCached:c,remove:v,clear:m,setContentType:y,setDefaultCtor:P}}]),angular.module("uebb.hateoas").factory("HateoasRequestError",function(){function e(t){Error.call(this),angular.isFunction(Error.captureStackTrace)&&Error.captureStackTrace(this,e),this.message="There was an error during a hateoas request",this.code=t.code,this.data=t.data,this.headers=t.headers,this.status=t.status}return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e.prototype.name="HateoasRequestError",e}),angular.module("uebb.hateoas").directive("hateoasLink",["Promise","$timeout","HateoasResource",function(e,t,r){return{restrict:"AEC",templateUrl:"uebb_hateoas_templates/hateoas-link.html",transclude:!0,replace:!1,scope:{resource:"=",rel:"@",as:"@",params:"&",labelPrefix:"@",disableSpinner:"=?",update:"=?",onLoad:"&",noResetOnRouteChange:"=?",ignoreCache:"&"},link:function(e,t,r,n,a){var i=e.$parent.$new();e.transcludeScope=i,a(i,function(e){t.find(".transclude-content").append(e)})},controller:["$scope",function(t){function n(){e.resolve(t.resource).then(function(e){if(e instanceof r){if(!t.update&&a===e&&i===t.rel)return;var n=t.update||t.ignoreCache();t.update=!1,a=e,i=t.rel,t.transcludeScope.error=null,t.transcludeScope[t.as||t.rel]=null,t.promise&&t.promise.isPending()&&t.promise.cancel(),t.promise=e.getLink(t.rel,t.params(),n).then(function(e){var r={};t.transcludeScope[t.as||t.rel]=r[t.as||t.rel]=e,t.onLoad(r)},function(e){t.transcludeScope.error=e})["finally"](function(){t.update=!1})}})}var a,i,o=t.$on("$routeChangeStart",function(){var e=t.transcludeScope[t.as||t.rel];e instanceof r&&!t.noResetOnRouteChange&&e.reset(),o()});t.$watch("resource",n),t.$watch("update",n),t.$watch("labelPrefix",function(){t.labelPrefix=t.labelPrefix&&""!==t.labelPrefix?t.labelPrefix:"general.item"}),t.labelPrefix=""}]}}]),angular.module("uebb.hateoas").directive("hateoasList",function(){"use strict";return{restrict:"EA",templateUrl:"uebb_hateoas_templates/hateoas-list.html",transclude:!0,replace:!1,scope:{resource:"=?",rel:"@",as:"@",resourceAs:"@",limit:"@",bare:"=?",order:"@",where:"@",page:"@",search:"@",update:"=?",orderFields:"=?",orderField:"@",orderDirection:"@",labelPrefix:"@",disableSpinner:"=?",disableMessages:"=?",disablePagination:"=?","if":"=",onLoad:"&",ignoreCache:"&"},link:function(e,t,r,n,a){e.transcludeScope=e.$parent.$new(),a(e.transcludeScope,function(r){e.bare?(t.find(".transclude-bare").replaceWith(r),r.find(".pagination").replaceWith(t.find(".hateoas-pagination")),r.find(".orderFields").replaceWith(t.find(".orderFields")),r.find(".response").replaceWith(t.find(".response")),t.find(".hateoas-list").remove()):t.find(".transclude-content").append(r)})},controller:["$scope","$timeout","HateoasResource","Promise",function(e,t,r,n){function a(){if(e["if"]!==!1){e.transcludeScope.error=null;var t=e.update||!!e.ignoreCache(),a=e.update;e.update=!1,n.resolve(e.resource).then(function(n){if(n instanceof r){var o=[];e.order&&""!==e.order&&o.push(e.order),e.orderField&&e.orderDirection&&o.push(e.orderField+" "+e.orderDirection),e.limit=parseInt(e.limit,10),isNaN(e.limit)&&(e.limit=10),e.page=parseInt(e.page,10),isNaN(e.page)&&(e.page=1);var l={search:e.search||"",limit:e.limit,order:o.join(","),where:e.where||"",page:e.page},s=JSON.stringify(l);if(s===i&&!a&&e.promise&&e.promise.isPending())return;i=s,e.promise&&e.promise.isPending()&&e.promise.cancel(),e.transcludeScope.error=null;var u={};e.promise=n.getLink(e.rel,l,t).then(function(t){return e.resourceAs&&(e.transcludeScope[e.resourceAs]=u[e.resourceAs]=t),e.pages=t.pages,e.page=""+t.page,e.result=t,t.getLinks("items")}).then(function(t){e.transcludeScope[e.as||e.rel]=u[e.as||e.rel]=t,e.onLoad(u)},function(t){e.transcludeScope.error=t})}})}}e.page=e.page||1;var i;e.$watch("if",a),e.$watch("page",a),e.$watch("limit",a),e.$watch("order",a),e.$watch("orderField",a),e.$watch("orderDirection",a),e.$watch("resource",a),e.$watch("labelPrefix",function(){e.labelPrefix=e.labelPrefix&&""!==e.labelPrefix?e.labelPrefix:"general.list"}),e.labelPrefix="",e.setOrder=function(t,r){e.orderField=t,e.orderDirection=r},e.$watch("orderFields",function(){e.orderFields&&e.orderFields.length&&("DESC"!==e.orderDirection&&(e.orderDirection="ASC"),e.orderField=-1===e.orderFields.indexOf(e.orderField)?e.orderFields[0]:e.orderField)}),e.$watch("update",function(e){e&&a()})}]}}),angular.module("uebb.hateoas").directive("hateoasSelectList",function(){"use strict";return{restrict:"EA",scope:{srcResource:"=",srcRel:"@",resource:"=",srcFilter:"=?",orderField:"@",orderDirection:"@",rel:"@",itemLabel:"@",labelPrefix:"@",removed:"=?",added:"=?",updateSelected:"=?",updateAvailable:"=?",disabled:"=?"},templateUrl:"uebb_hateoas_templates/hateoasSelectList.html",link:function(e,t){e.$watch("disabled",function(e){t.css(e?{"pointer-events":"none"}:{"pointer-events":"auto"})})},controller:["$scope","debounce","HateoasResource",function(e,t,r){e.removed=e.removed||[],e.added=e.added||[],e.itemLabel=e.itemLabel||"item.name",e.labelPrefix=e.labelPrefix||"general.select_list",e.indexOf=function(e,t){if(!(Array.isArray(t)&&e instanceof r))return-1;var n;for(n=0;n<t.length;n++)if(t[n].getHref("self")===e.getHref("self"))return n;return-1},e.inArray=function(t,r){return-1!==e.indexOf(t,r)},e.add=function(t){e.inArray(t,e.added)||e.added.push(t)},e.remove=function(t){e.inArray(t,e.removed)||e.removed.push(t)},e.undoAdd=function(t){e.added.splice(e.indexOf(t,e.added),1)},e.undoRemove=function(t){e.removed.splice(e.indexOf(t,e.removed),1)},e.$watch("searchSelected",t(function(){e.updateSelected=!0},100)),e.$watch("searchAvailable",t(function(){e.updateAvailable=!0},100))}]}}),angular.module("uebb.hateoas").factory("hateoasUtil",function(){var e={embeddedProperty:"_embedded",linksProperty:"_links",copy:function(e,t){t=t||{};var r;for(r in e)e.hasOwnProperty(r)&&"$"!==r.charAt(0)&&"$"!==r.charAt(1)&&(t[r]=e[r]);return t},flatten:function(e){function t(e,n){var a,i,o,l=!0;if(e instanceof File||Object(e)!==e)r[n]=e;else if(Array.isArray(e)){for(a=0,i=e.length;i>a;a++)t(e[a],n?n+"["+a+"]":""+a);0===i&&(r[n]=[])}else for(o in e)e.hasOwnProperty(o)&&(l=!1,t(e[o],n?n+"["+o+"]":o))}if(!e||angular.isString(e)||angular.isNumber(e))return e;var r={};return t(e,""),r},addParamsToUrl:function(t,r){return r&&(r=e.flatten(r),t=new URI(t),angular.forEach(r,function(e,n){r.hasOwnProperty(n)&&(t.removeSearch(n),t.addSearch(n,e))}),t=t.toString()),t},expandUriTemplate:function(t,r){if(r){r=e.flatten(r);var t=URI.expand(t,function(e){var t=r[e];return delete r[e],t}).toString();return this.addParamsToUrl(t)}return t},convertJsonToFormData:function(t){var r=new FormData;return t=e.flatten(t),console.log("data",t),Object.keys(t).forEach(function(e){r.append(e,t[e])}),r},normalizeUrl:function(e){var t=new URI(e),r=URI.parseQuery(t.query()),n={};return angular.forEach(Object.keys(r).sort(),function(e){(r[e]||0===r[e]||r[e]===!1)&&(n[e]=r[e])}),t.query(URI.buildQuery(n)),t.normalize(),t.toString()},getLinks:function(t){function r(e,t){for(var r=0;r<t.length;r++)if(t[r].href===e.href)return!0;return!1}var n=angular.copy(t[e.linksProperty])||{};return angular.forEach(Object.keys(t[e.embeddedProperty]||{}),function(a){var i=n[a],o=t[e.embeddedProperty][a];Array.isArray(o)?(n[a]=[],Array.isArray(i)?angular.forEach(function(e){n[a].push(e)}):i&&n[a].push(i),angular.forEach(o,function(t){r(t[e.linksProperty].self,n[a])||n[a].push(t[e.linksProperty].self)})):i?Array.isArray(i)?r(o[e.linksProperty].self,i)||n[a].push(o[e.linksProperty].self):i.href!==o[e.linksProperty].self.href&&(n[a]=[o[e.linksProperty].self,i]):n[a]=o[e.linksProperty].self}),n},getProperties:function(t){var r=angular.copy(t);return delete r[e.linksProperty],delete r[e.embeddedProperty],r},getNormalizedData:function(t){var r=e.getProperties(t);return r[e.linksProperty]=e.getLinks(t),r},mergeLink:function(e,t){if(t&&t.length){var r=new URI(e);return r.resource(r.resource()+"/"+t).toString()}return e},getPatch:function(t,r){var n=t[e.linksProperty],a=r[e.linksProperty],i=function(e){return e.reduce(function(e,t){return e.indexOf(t)<0&&e.push(t),e},[])},o=i([].concat(Object.keys(t),Object.keys(r)));o.splice(o.indexOf(e.linksProperty),1);var l=[];angular.forEach(o,function(e){JSON.stringify(t[e])!==JSON.stringify(r[e])&&l.push({op:"replace",path:"/"+e,value:r[e]})});var s=i([].concat(Object.keys(t[e.linksProperty]),Object.keys(r[e.linksProperty])));return angular.forEach(s,function(t){var r=[],i=[];angular.isArray(n[t])?r=n[t]:n[t]&&r.push(n[t]),angular.isArray(a[t])?i=a[t]:a[t]&&i.push(a[t]);var o=[];angular.forEach(r,function(e){var t=!1;angular.forEach(i,function(r){e.href===r.href&&(t=!0)}),t||o.push(e)}),o.length&&l.push({op:"remove",path:"/"+e.linksProperty+"/"+t,value:o});var s=[];angular.forEach(i,function(e){var t=!1;angular.forEach(r,function(r){r.href===e.href&&(t=!0)}),t||s.push(e)}),s.length&&l.push({op:"add",path:"/"+e.linksProperty+"/"+t,value:s})}),l}};return e}),angular.module("uebb.hateoas").factory("Promise",["$rootScope",function(e){return window.Promise.setScheduler(function(t){e.$evalAsync(t)}),window.Promise}]),angular.module("uebb.hateoas").directive("selectFile",["$timeout","HateoasResource",function(e,t){return{templateUrl:"uebb_hateoas_templates/select-file.html",restrict:"E",scope:{linkRel:"@",linkResource:"=?",resource:"&",uploadProperty:"=?",multiple:"=?",files:"=?",mimeTypes:"=?",upload:"=?",max:"=?",maxFilesize:"@",errors:"=?",updateExisting:"=?",errorPrefix:"@",label:"@"},link:function(r,n){r.data={updateExisting:!1},r.uploadProperty=r.uploadProperty||"upload",r.files=r.files||[],n.find("input[type=file]").on("change",function(n){e(function(){for(var e,a=0;a<n.target.files.length&&(!r.max||a<r.max);a++)e=r.resource()||new t,e[r.uploadProperty||"upload"]=n.target.files.item(a),r.linkResource&&r.linkRel&&!e.hasLink(r.linkRel,r.linkResource)&&e.setLink(r.linkRel,r.linkResource),r.files.push(e);n.target.value=""})}),r.$watch("label",function(e){e&&""!==e||(r.label="general.choose_file")}),r.$watch("files.length",function(e){n.find("input[type=file]").prop("disabled",r.multiple?r.max&&e>=r.max:e>=1)}),r.$watch("multiple",function(e){n.find("input[type=file]").prop("multiple",!!e),e&&"general.choose_file"===r.label&&(r.label="general.choose_files"),e||"general.choose_files"!==r.label||(r.label="general.choose_file")}),r.$watch("updateExisting",function(e){r.data.updateExisting=e}),r.$watch("data.updateExisting",function(e){r.updateExisting=e}),r.getFileErrors=function(e){var t=null;return angular.isArray(r.errors)&&angular.forEach(r.errors,function(r){r.item===e&&(t=r.errors)}),t}}}}]),angular.module("uebb.hateoas").directive("selectHateoas",["$timeout",function(e){return{restrict:"EA",scope:{url:"=?",multiple:"=",label:"@",placeholder:"@",selected:"=?",disabled:"=",preselectedIds:"=?",onAdd:"&",onRemove:"&",rel:"@",resource:"=",srcResource:"=?",srcRel:"@",created:"=?",createFactory:"&",removed:"=?",limit:"=",where:"=",order:"=",clearButton:"="},replace:!0,templateUrl:"uebb_hateoas_templates/select-hateoas.html",link:function(t,r){function n(){t.disabled||e(function(){t.active=t.multiple===!0||t.selected.length<t.multiple||!t.multiple,t.showDropdown=t.active,t.focus()})}function a(n){return e(function(){$.contains(r[0],n.target)||(t.showDropdown=!1,t.active=!1,$(document).off("mousedown",a))}),!0}t.focus=function(){e(function(){r.find("input.search").focus()}),$(document).on("mousedown",a)},r.on("mouseenter",".chosen-results li",function(){$(this).addClass("highlighted")}),r.on("mouseleave",".chosen-results li",function(){$(this).removeClass("highlighted")}),r.on("keydown",function(r){13===r.keyCode?(r.preventDefault(),t.selectWithEnter(),e(function(){n()},200)):40===r.keyCode?(r.preventDefault(),t.preSelectNext()):38===r.keyCode&&(r.preventDefault(),t.preSelectPrev())}),r.on("click",".chosen-choices, .chosen-single",function(){n()})},controller:["$scope","HateoasResource","HateoasCollection","$timeout","Promise",function(e,t,r,n,a){function i(e,t){for(var r=0;r<e.length;r++)if(e[r].id===t.id)return r;return-1}e.add=function(r){if(e.multiple){if(e.multiple!==!0&&e.selected.length>=e.multiple)return;e.remove(r)}else angular.forEach(e.selected,function(t){e.remove(t)});e.selected.push(r),e.onAdd({item:r}),e.resource instanceof t&&e.rel&&-1===i(e.existing,r)&&e.resource.setLink(e.rel,r,!e.multiple),e.search="",e.showDropdown=!1,e.multiple===!0||e.selected.length<e.multiple?e.focus():e.active=!1,e.query()},e.selected||(e.selected=[]),e.removed||(e.removed=[]),e.existing=[],e.$watch("resource",function(){a.resolve(e.resource).then(function(n){if(n instanceof t){if(!n.hasHref(e.rel))return;var a;e.multiple&&(a={limit:e.multiple===!0?0:e.multiple}),e.resource.getLink(e.rel,a).then(function(t){e.selected.length=0,e.existing.length=0,t instanceof r?(e.selected.push.apply(e.selected,t.items),e.existing.push.apply(e.existing,t.items)):(e.selected.push(t),e.existing.push(t))},function(){})}})}),e.search="",e.active=!1,e.displayCreate=!1,e.remove=function(t){t.hasHref("self")?angular.forEach(e.selected,function(r){t.getHref("self")===r.getHref("self")&&(e.selected.splice(e.selected.indexOf(r),1),e.onRemove({item:r}),e.resource&&e.rel&&e.resource.removeLink(e.rel,t,-1!==i(e.existing,t)))}):e.selected.splice(e.selected.indexOf(t),1),e.created&&e.created.splice(e.created.indexOf(t),1),e.query()},e.isNotSelected=function(t){return!e.isSelected(t)},e.isSelected=function(t){for(var r=0;r<e.selected.length;r++)if(t.getHref("self")===e.selected[r].getHref("self"))return!0;return!1},e.page=1,e.changePage=function(t){1>t?t=1:t>e.request.value().pages&&(t=e.request.value().pages),e.page=t,e.query()};var o=null;e.query=function(){e.request=null,e.displayCreate=!1,o&&n.cancel(o);var r=e.selected.map(function(e){return"id != "+e.id});e.where&&r.unshift(e.where);var a={page:e.page||1,limit:e.limit||10,search:e.search||"",order:e.order||void 0,where:r.join(" AND ")};o=n(function(){e.request=t.get(e.url,a).then(function(t){angular.forEach(t.items,function(e){e.selected=!1});for(var r=0;r<t.items.length;r++)if(e.isNotSelected(t.items[r])){e.preSelectedIndex=r,t.items[r].selected=!0;break}if(e.search&&e.created){var n=!1;angular.forEach(t.items,function(t){t===e.search&&(n=!0)}),e.displayCreate=!n}return t}),e.selectedIndex=0},250)},e.create=function(){a.resolve(e.createFactory({search:e.search})).then(function(t){e.created.push(t),e.selected.push(t),e.search="",e.showDropdown=!1,n(e.query,100)})},e.type=function(t){8===t.keyCode&&""===e.search&&e.selected.length&&e.remove(e.selected[e.selected.length-1])},e.$watch("url",function(){e.url&&e.query()}),e.$watch("srcResource",function(r){a.resolve(r).then(function(r){r instanceof t&&e.srcRel&&(e.url=r.getHref(e.srcRel)),!e.resource&&angular.isArray(e.preselectedIds)&&e.preselectedIds.length&&(e.multiple?angular.isNumber(e.multiple)&&e.preselectedIds.length>e.multiple&&(e.preselectedIds.length=e.multiple):e.preselectedIds.length=1,t.get(e.url,{limit:0,where:e.preselectedIds.map(function(e){return"id = "+e}).join(" OR ")}).then(function(t){e.selected.length=0,e.selected.push.apply(e.selected,t.items)}))})}),e.preSelectedIndex=null,e.preSelectedItem=null,e.$watch("preSelectedIndex",function(t,r){angular.isUndefined(t)||null===t?e.preSelectedItem=null:angular.isDefined(e.request.value().items[t])?(angular.isDefined(e.request.value().items[r])&&(e.request.value().items[r].selected=!1),e.preSelectedItem=e.request.value().items[t],e.preSelectedItem.selected=!0):e.preSelectedIndex=null}),e.preSelectNext=function(){if(e.request&&!e.request.isPending()){var t=e.preSelectedIndex+1;t>=e.request.value().items.length-1&&(t=e.request.value().items.length-1);for(var r=!1,n=t;n<e.request.value().items.length;n++)if(e.isNotSelected(e.request.value().items[n])){t=n,r=!0;break}r||(t=null),e.$apply(function(){e.preSelectedIndex=t})}},e.preSelectPrev=function(){if(e.request&&!e.request.isPending()){var t=e.preSelectedIndex-1;0>t&&(t=0);for(var r=!1,n=t;n>=0;n--)if(e.isNotSelected(e.request.value().items[n])){t=n,r=!0;break}r||(t=null),e.$apply(function(){e.preSelectedIndex=t})}},e.selectWithEnter=function(){e.request&&!e.request.isPending()&&(angular.isDefined(e.request.value().items[e.preSelectedIndex])?e.add(e.request.value().items[e.preSelectedIndex]):e.create())}}]}}]);